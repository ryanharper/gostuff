package main

import (
	"fmt"
	"log"
	"os"

	"gopkg.in/yaml.v3"
	"helm.sh/helm/v3/pkg/action"
	"helm.sh/helm/v3/pkg/chart/loader"
	"helm.sh/helm/v3/pkg/cli"
	"helm.sh/helm/v3/pkg/registry"
)

type Config struct {
	Helm []struct {
		Repo         string `yaml:"repo"`
		Charts       []struct {
			Name    string `yaml:"name"`
			Version string `yaml:"version"`
		} `yaml:"charts"`
		Destinations []struct {
			Path string `yaml:"path"`
		} `yaml:"destinations"`
	} `yaml:"helm"`
}

func main() {
	// 1. Load Configuration
	config, err := loadConfig("config.yaml")
	if err != nil {
		log.Fatalf("Error loading config: %v", err)
	}

	// 2. Initialize Helm settings
	settings := cli.New()

	// 3. Iterate through configurations
	for _, helmConfig := range config.Helm {
		for _, chart := range helmConfig.Charts {
			for _, destination := range helmConfig.Destinations {

				// 3a. Pull Chart
				// Registry client for pull
				registryClientPull, err := registry.NewClient(
					registry.ClientOptDebug(settings.Debug),
					registry.ClientOptEnableCache(true),
					registry.ClientOptWriter(os.Stdout),
					registry.ClientOptCredentialsFile(settings.RegistryConfig),
				)
				if err != nil {
					log.Fatalf("Failed to create registry client for pull: %v", err)
				}

				//Set action configuration for Pull
				actionConfigPull := new(action.Configuration)
				if err := actionConfigPull.Init(settings.RESTClientGetter(), settings.Namespace(), os.Getenv("HELM_DRIVER"), log.Printf); err != nil {
					log.Fatalf("Failed to init action config for pull: %v", err)
				}
				actionConfigPull.RegistryClient = registryClientPull

				chartPath, err := pullChart(settings, helmConfig.Repo, chart.Name, chart.Version, actionConfigPull)
				if err != nil {
					log.Printf("Error pulling chart %s: %v", chart.Name, err)
					continue // Move to the next destination/chart if pull fails
				}
				log.Printf("Pulled chart %s to %s\n", chart.Name, chartPath)

				// 3b. Push Chart
				// Registry client for push
				registryClientPush, err := registry.NewClient(
					registry.ClientOptDebug(settings.Debug),
					registry.ClientOptEnableCache(true),
					registry.ClientOptWriter(os.Stdout),
					registry.ClientOptCredentialsFile(settings.RegistryConfig),
				)
				if err != nil {
					log.Fatalf("Failed to create registry client for push: %v", err)
				}

				//Set action configuration for Push
				actionConfigPush := new(action.Configuration)
				if err := actionConfigPush.Init(settings.RESTClientGetter(), settings.Namespace(), os.Getenv("HELM_DRIVER"), log.Printf); err != nil {
					log.Fatalf("Failed to init action config for push: %v", err)
				}
				actionConfigPush.RegistryClient = registryClientPush

				if err := pushChart(settings, chartPath, destination.Path, actionConfigPush); err != nil {
					log.Printf("Error pushing chart %s to %s: %v", chart.Name, destination.Path, err)
					continue
				}
				log.Printf("Pushed chart %s to %s\n", chart.Name, destination.Path)

				// 3c. Clean up temp file
				if err := os.RemoveAll(chartPath); err != nil {
					log.Printf("Error cleaning up temp file %s: %v", chartPath, err)
				}
			}
		}
	}

	fmt.Println("Helm operations completed.")
}

// loadConfig loads the YAML configuration file.
func loadConfig(filename string) (*Config, error) {
	data, err := os.ReadFile(filename)
	if err != nil {
		return nil, err
	}

	var config Config
	if err := yaml.Unmarshal(data, &config); err != nil {
		return nil, err
	}
	return &config, nil
}

// pullChart pulls the specified chart from the Helm repository.
func pullChart(settings *cli.EnvSettings, repoURL, chartName, chartVersion string, actionConfig *action.Configuration) (string, error) {
	pull := action.NewPullWithOpts(action.WithConfig(actionConfig)) // action.PullOpt
	pull.Settings = settings
	pull.RepoURL = repoURL
	pull.Version = chartVersion
	pull.DestDir = os.TempDir()

	result, err := pull.Run(chartName)
	if err != nil {
		return "", fmt.Errorf("failed to pull chart: %w", err)
	}
	return result.DownloadedPath, nil
}

// pushChart pushes the chart to the OCI registry.
func pushChart(settings *cli.EnvSettings, chartPath, destination string, actionConfig *action.Configuration) error {
	_, err := loader.Load(chartPath)
	if err != nil {
		return fmt.Errorf("failed to load chart: %w", err)
	}

	push := action.NewPushWithOpts(action.WithConfig(actionConfig)) // action.PushOpt
	push.Settings = settings

	_, err = push.Run(chartPath, destination)
	if err != nil {
		return fmt.Errorf("failed to push chart: %w", err)
	}

	return nil
}
